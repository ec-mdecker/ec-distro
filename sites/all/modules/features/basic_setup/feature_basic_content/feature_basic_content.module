<?php
/**
 * @file
 * Code for the Feature Basic Content feature.
 */

include_once 'feature_basic_content.features.inc';

/*
 * Implements hook_views_query_alter().
 */
function feature_basic_content_views_query_alter(&$view, &$query) {

//  $displays = array(
//    'block',
//    'block_1',
//    'block_2',
//    'block_3',
//    'block_4',
//  );
//
//  if (($view->name == 'basic_blocks_displays' || $view->name == 'basic_blocks_sort') && in_array($view->current_display, $displays)) {
//    //copies the existing filters
//    $single_page = $query->where[1];
//
//    //changes the boolean value in the copied conditions. This sets the boolean condition to true
//    $single_page['conditions'][3]['value'] = 1;
//    //joins the two conditions. so that when the boolean is true, the contextual filter for 'per path' will match up
//    $single_page['conditions'][] = $query->where[0]['conditions'][1];
//
//    //joins the contextual filter for active trail with the condition that has the boolean as false
//    $query->where[1]['conditions'][] = $query->where[0]['conditions'][0];
//    //inserts the conditions from earlier for 'per path' into the query.
//    $query->where[] = $single_page;
//
//    //unsets the contextual filters
//    unset($query->where[0]);
//  }
}

/**
 *  Implements hook_node_view().
 */
function feature_basic_content_node_view($node, $view_mode, $langcode) {
  switch ($node->type) {
    case 'basic_page':
      if (isset($node->field_basic_page_tabs)) {
        $settings = array(
          'hide_empty_tabs' => TRUE,
          'ajax' => FALSE,
          'style' => 'Zen',
          'default_tab' => 0,
        );
        $tabs = array();
        $content = $node->content;

        if (isset($content['field_basic_page_tabs'])) {
          foreach ($content['field_basic_page_tabs']['#items'] as $delta => $item) {
            $tab = $content['field_basic_page_tabs'][$delta]['entity']['field_collection_item'][$item['value']];
            $tabs[] = array(
              'title' => isset($tab['field_basic_page_tab_label']) ? $tab['field_basic_page_tab_label'][0]['#markup'] : 'Tab',
              'contents' => array(
                '#markup' => isset($tab['field_basic_page_tab_body']) ? $tab['field_basic_page_tab_body'][0]['#markup'] : '',
              ),
            );
          }
          $quicktab = quicktabs_build_quicktabs('content-tab', $settings, $tabs);
          $node->content['field_basic_page_tabs'] = $quicktab;
        }
      }
      break;
  }
}